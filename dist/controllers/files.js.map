{"version":3,"file":"files.js","names":["models","require","Storage","v4","uuidv4","projectId","keyFilename","storage","bucket","renameFile","srcFileName","destFileName","file","rename","console","log","uploadCV","req","res","originalName","originalname","uuidName","blob","blobStream","createWriteStream","extension","split","newFullNameFile","concat","mimeType","mimetype","id","headers","on","status","send","end","buffer","setTimeout","updateCv","error","uploadLogo","updateLogo","uploadFoto","updateFoto","fetchFileFromGoogleStorage","fileName","fileObject","fileContents","download","getFiles","type","downloadedImageFile","nombreFoto","foto","postulantes","update","where","nombreCv","cv","nombreLogo","logo","empresas"],"sources":["../../src/controllers/files.js"],"sourcesContent":["const models = require(\"../../database/models\");\r\nconst { Storage } = require(\"@google-cloud/storage\");\r\nconst { v4: uuidv4 } = require('uuid');\r\n\r\n\r\nlet projectId = \"red-seeker-365622\"; // Google Cloud\r\nlet keyFilename = \"./red-seeker-365622-b037b7220de8.json\"; // Google Cloud -> Credentials -> Service Accounts\r\nconst storage = new Storage({\r\n  projectId,\r\n  keyFilename,\r\n});\r\nconst bucket = storage.bucket(\"comunidadstorage\"); // Cloud -> Storage\r\n\r\nasync function renameFile(srcFileName, destFileName) {\r\n  await bucket.file(srcFileName).rename(destFileName);\r\n  console.log(\r\n    `${srcFileName} renamed to ${destFileName}`\r\n  )};\r\n\r\nexport const uploadCV = async (req, res) => {\r\n  try {\r\n    if (req.file) {\r\n      const originalName = req.file.originalname;\r\n      const uuidName = uuidv4();\r\n      const blob = bucket.file(originalName);\r\n      const blobStream = blob.createWriteStream();\r\n      const extension = originalName.split('.',2);\r\n      const newFullNameFile = uuidName.concat('.', extension[1]);\r\n      const mimeType = req.file.mimetype;\r\n      const id = req.headers.id\r\n      \r\n      blobStream.on(\"finish\", () => {\r\n        res.status(200).send(\"Success\");\r\n        console.log(\"Success\");\r\n      });\r\n      blobStream.end(req.file.buffer);\r\n      setTimeout(() => {\r\n      renameFile(originalName, newFullNameFile); }, 5000);\r\n      updateCv(id,mimeType,newFullNameFile);\r\n    } else throw \"algun error con la subida de archivo\";\r\n  }catch (error) {\r\n    res.status(500).send(error);\r\n  }\r\n};\r\n\r\nexport const uploadLogo = async (req, res) => {\r\n  try {\r\n    if (req.file) {\r\n      const originalName = req.file.originalname;\r\n      const uuidName = uuidv4();\r\n      const blob = bucket.file(originalName);\r\n      const blobStream = blob.createWriteStream();\r\n      const extension = originalName.split('.',2);\r\n      const newFullNameFile = uuidName.concat('.', extension[1]);\r\n      const mimeType = req.file.mimetype;\r\n      const id = req.headers.id\r\n      \r\n      blobStream.on(\"finish\", () => {\r\n        res.status(200).send(\"Success\");\r\n        console.log(\"Success\");\r\n      });\r\n      blobStream.end(req.file.buffer);\r\n      setTimeout(() => {\r\n      renameFile(originalName, newFullNameFile); }, 5000);\r\n      updateLogo(id,mimeType,newFullNameFile);\r\n    } else throw \"algun error con la subida de archivo\";\r\n  }catch (error) {\r\n    res.status(500).send(error);\r\n  }\r\n};\r\n\r\nexport const uploadFoto = async (req, res) => {\r\n  try {\r\n    if (req.file) {\r\n      const originalName = req.file.originalname;\r\n      const uuidName = uuidv4();\r\n      const blob = bucket.file(originalName);\r\n      const blobStream = blob.createWriteStream();\r\n      const extension = originalName.split('.',2);\r\n      const newFullNameFile = uuidName.concat('.', extension[1]);\r\n      const mimeType = req.file.mimetype;\r\n      const id = req.headers.id\r\n      \r\n      blobStream.on(\"finish\", () => {\r\n        res.status(200).send(\"Success\");\r\n        console.log(\"Success\");\r\n      });\r\n      blobStream.end(req.file.buffer);\r\n      setTimeout(() => {\r\n      renameFile(originalName, newFullNameFile); }, 5000);\r\n      updateFoto(id,mimeType,newFullNameFile);\r\n    } else throw \"algun error con la subida de archivo\";\r\n  }catch (error) {\r\n    res.status(500).send(error);\r\n  }\r\n};\r\n\r\n\r\nasync function fetchFileFromGoogleStorage(fileName) {\r\n  const fileObject = bucket.file(fileName);\r\n  const fileContents = await fileObject.download();\r\n  return fileContents[0];\r\n};\r\n\r\nexport const getFiles = async (req, res) => {\r\n  let fileName = req.headers.file;\r\n  let type = req.headers.type;\r\n  console.log(\"este es el file\", fileName);\r\n  console.log(\"este es el type\", type);\r\n  const downloadedImageFile = await fetchFileFromGoogleStorage(fileName);\r\n  res.status(200);\r\n  res.type(type);\r\n  res.send(downloadedImageFile);\r\n};\r\n\r\n//Con esto actualizamos la foto \r\nconst updateFoto = (id, mimeType, nombreFoto) => {\r\n  const foto = mimeType.concat('|', nombreFoto);\r\n\r\n  models.postulantes.update(\r\n    { foto: foto },\r\n    {\r\n      where: {\r\n        id: id,\r\n      },\r\n    }\r\n  );\r\n};\r\n\r\n//Con esto actualizamos el CV\r\nconst updateCv = (id, mimeType, nombreCv) => {\r\n  const cv = mimeType.concat('|', nombreCv);\r\n\r\n  models.postulantes.update(\r\n    { cv: cv },\r\n    {\r\n      where: {\r\n        id: id,\r\n      },\r\n    }\r\n  );\r\n};\r\n\r\n//Con esto actualizamos el Logo\r\nconst updateLogo = (id, mimeType, nombreLogo) => {\r\n  const logo = mimeType.concat('|', nombreLogo);\r\n\r\n  models.empresas.update(\r\n    { logo: logo },\r\n    {\r\n      where: {\r\n        id: id,\r\n      },\r\n    }\r\n  );\r\n};"],"mappings":"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"}